<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>O Poder do Dedo - Layout Melhorado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-storage-compat.js"></script>

  <!-- QRCode lib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    /* RESET BÁSICO */
    * {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
    }
    body, html {
      width: 100%; 
      height: 100%;
      background: #f0f0f0; 
      font-family: Arial, sans-serif;
      display: flex; 
      flex-direction: column;
      align-items: center;
    }

    /* Contêiner principal com aspect-ratio (16:9 / 9:16) */
    #mainContainer {
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
      aspect-ratio: 16/9; /* Landscape */
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    /* Se o device estiver em portrait (celular em pé) */
    @media (orientation: portrait) {
      #mainContainer {
        aspect-ratio: 9/16;
      }
    }

    #contentScroll {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex; 
      flex-direction: column;
      gap: 20px;
    }

    h1 {
      text-align: center;
      margin: 10px 0;
      font-size: 1.5rem;
      color: #444;
    }

    .hidden { display: none !important; }
    .section {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .title {
      text-align: center; 
      font-weight: bold;
      margin-bottom: 10px;
      color: #444;
    }

    button {
      display: inline-flex;
      align-items: center; 
      padding: 10px 14px;
      border: none; 
      border-radius: 5px;
      margin: 5px 0; 
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    button img {
      width: 20px; 
      height: 20px; 
      margin-right: 5px; 
      vertical-align: middle;
    }
    button:hover {
      opacity: 0.9;
    }
    .btn-dark    { background: #555; color: #fff; }
    .btn-primary { background: #007BFF; color: #fff; }
    .btn-success { background: #28a745; color: #fff; }
    .btn-danger  { background: #dc3545; color: #fff; }
    .btn-warning { background: #ffc107; color: #212529; }
    .btn-info    { background: #17a2b8; color: #fff; }

    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .status-panel {
      background: #e7f3ff;
      border: 1px solid #bee0ff;
      border-radius: 5px;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      color: #007BFF;
      margin-bottom: 10px;
    }

    /* Painel (Eventos) em destaque */
    .panel-box {
      background: #fefff8; /* tom levemente esverdeado */
      border: 2px solid #c5e3a4; /* borda mais forte */
      border-radius: 5px;
      max-height: 200px; /* maior */
      overflow-y: auto;
      padding: 10px;
      margin-top: 8px;
      color: #2c3e50;
      font-weight: bold; /* maior destaque */
    }
    /* Chat e Regras */
    .chat-box {
      background: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 5px;
      max-height: 150px;
      overflow-y: auto;
      padding: 10px;
      margin-top: 8px;
    }
    .rules-box {
      background: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      min-height: 60px;
    }
    .rule-item {
      background: #eee;
      margin: 4px 0;
      padding: 4px;
      border-radius: 3px;
    }

    /* Cartas e Baralho */
    .card-front {
      width: 100px; 
      height: 140px;
      border: 2px solid #000;
      border-radius: 6px;
      background: #fff;
      margin: 5px auto;
      position: relative;
      color: #000;
    }
    .card-rank-suit {
      position: absolute; top:8px; left:8px; font-size:1.4rem; font-weight:bold;
    }
    .red { color: red; }
    .black { color: #000; }
    .card-back {
      width: 15px; 
      height:25px;
      background: #bbb;
      border-radius:3px;
      display:inline-block;
      margin:2px;
    }
    #deckView, #deckViewPlayer {
      display:flex; 
      flex-wrap:wrap; 
      max-width:80px; 
      margin-top:5px;
    }

    .finger-box {
      background: #fffde7;
      border: 1px solid #eee27f;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
    }

    #videoOverlay {
      position: fixed; 
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.8);
      color:#fff;
      display:none;
      flex-direction:column; 
      align-items:center; 
      justify-content:center;
      z-index:9999;
      padding:10px;
    }
    video {
      background:#000; 
      max-width:90vw; 
      max-height:60vh;
    }
  </style>
</head>

<body>
  <div id="mainContainer">
    <div id="contentScroll">
      <h1>O Poder do Dedo</h1>

      <!-- Modo Seletor -->
      <div id="modeSelect" class="section">
        <div class="title">Você é o Organizador ou Jogador?</div>
        <button id="btnHost" class="btn-dark">
          <img src="https://cdn-icons-png.flaticon.com/512/3771/3771452.png" alt="host icon"/>
          Organizador
        </button>
        <button id="btnPlayer" class="btn-primary">
          <img src="https://cdn-icons-png.flaticon.com/512/8374/8374833.png" alt="player icon"/>
          Jogador
        </button>
      </div>

      <!-- HOST AREA -->
      <div id="hostArea" class="hidden">
        <div id="hostStep1" class="section">
          <div class="title">Criar ou Entrar numa Partida</div>
          <button id="btnCreateGame" class="btn-success">
            <img src="https://cdn-icons-png.flaticon.com/512/990/990964.png" alt="add icon"/>
            Criar Nova Partida
          </button>
          <p style="margin-top:10px;text-align:center;">Ou entre numa partida existente:</p>
          <input type="text" id="inputGameCodeHost" placeholder="Código..." />
          <button id="btnJoinGameHost" class="btn-info">
            <img src="https://cdn-icons-png.flaticon.com/512/2997/2997918.png" alt="enter icon"/>
            Entrar
          </button>
        </div>

        <div id="hostLobby" class="hidden section">
          <div class="title">Lobby da Partida</div>
          <p>Código: <span id="hostGameCode"></span></p>
          <div style="text-align:center;">
            <div id="qrCodeLobby"></div>
            <p id="hostLinkInfo" style="margin-top:5px;font-size:0.9rem;"></p>
          </div>
          <h4 style="margin-top:10px;">Jogadores Conectados</h4>
          <div id="hostPlayersList"></div>
          <button id="btnStartGame" class="btn-primary" style="margin-top:10px;">
            <img src="https://cdn-icons-png.flaticon.com/512/1828/1828490.png" alt="start icon"/>
            Iniciar Partida
          </button>
        </div>

        <div id="hostGame" class="hidden section">
          <div id="hostStatusPanel" class="status-panel"></div>

          <div style="text-align:center;margin-bottom:10px;" id="qrCodeGame"></div>

          <h4>Carta Atual</h4>
          <div id="currentCardHost">Nenhuma</div>
          <button id="btnDrawCard" class="btn-warning" style="margin-top:8px;">
            <img src="https://cdn-icons-png.flaticon.com/512/729/729495.png" alt="card icon"/>
            Puxar Carta
          </button>

          <h4 style="margin-top:15px;">Baralho</h4>
          <div id="deckCount"></div>
          <div id="deckView"></div>

          <h4 style="margin-top:15px;">Regras Ativas</h4>
          <div id="hostRules" class="rules-box"></div>

          <h4 style="margin-top:15px;">Jogadores</h4>
          <div id="hostPlayersStatus"></div>

          <h4 style="margin-top:15px;">Painel (Eventos)</h4>
          <div id="hostPainel" class="panel-box"></div>

          <h4>Chat</h4>
          <div id="hostChat" class="chat-box"></div>
          <input type="text" id="hostChatInput" placeholder="Digite uma mensagem..." />
          <button id="btnHostSendChat" class="btn-info" style="margin-top:5px;">
            <img src="https://cdn-icons-png.flaticon.com/512/3048/3048122.png" alt="chat icon"/>
            Enviar
          </button>

          <button id="btnEndGame" class="btn-danger" style="margin-top:10px;">
            <img src="https://cdn-icons-png.flaticon.com/512/1828/1828843.png" alt="stop icon"/>
            Encerrar Partida
          </button>
        </div>
      </div>

      <!-- PLAYER AREA -->
      <div id="playerArea" class="hidden">
        <div id="playerStep1" class="section">
          <div class="title">Entrar Numa Partida</div>
          <input type="text" id="inputGameCodePlayer" placeholder="Código..." />
          <button id="btnEnterCodePlayer" class="btn-info" style="margin-top:8px;">
            <img src="https://cdn-icons-png.flaticon.com/512/2997/2997918.png" alt="enter icon"/>
            Entrar
          </button>
          <p style="margin-top:8px;font-size:0.8rem;text-align:center;">ou use o QR Code</p>
        </div>

        <div id="playerRegister" class="hidden section">
          <div class="title">Digite Seu Nome</div>
          <input type="text" id="inputPlayerName" placeholder="Seu nome..." />
          <button id="btnJoinPlayerGame" class="btn-success" style="margin-top:8px;">
            <img src="https://cdn-icons-png.flaticon.com/512/1828/1828817.png" alt="ok icon"/>
            Entrar na Partida
          </button>
        </div>

        <div id="playerLobby" class="hidden section">
          <div class="title">Aguardando Organizador Iniciar...</div>
          <div id="playerLobbyList"></div>
        </div>

        <div id="playerGame" class="hidden section">
          <div id="playerStatusPanel" class="status-panel hidden"></div>

          <h4>Carta Atual</h4>
          <div id="currentCardPlayer">Nenhuma</div>
          <button id="btnDrawCardPlayer" class="btn-warning" style="display:none; margin-top:8px;">
            <img src="https://cdn-icons-png.flaticon.com/512/729/729495.png" alt="card icon"/>
            Puxar Carta
          </button>

          <h4 style="margin-top:15px;">Baralho</h4>
          <div id="deckCountPlayer"></div>
          <div id="deckViewPlayer"></div>

          <h4 style="margin-top:15px;">Regras Ativas</h4>
          <div id="playerRules" class="rules-box"></div>

          <h4 style="margin-top:15px;">Jogadores</h4>
          <div id="playerListStatus"></div>

          <div class="finger-box hidden" id="fingerBox">
            <h4>Poder do Dedo Ativo!</h4>
            <p>Seja rápido para não perder!</p>
            <button id="btnFingerClick" class="btn-danger" style="margin-top:5px;">
              <img src="https://cdn-icons-png.flaticon.com/512/25/25690.png" alt="hand icon"/>
              Clique agora!
            </button>
            <div id="fingerQueue" style="margin-top:5px;"></div>
          </div>

          <div style="text-align:center;">
            <button id="btnUseJoker" class="btn-info" style="display:none;">
              <img src="https://cdn-icons-png.flaticon.com/512/3495/3495672.png" alt="joker icon"/>
              Usar Coringa
            </button>
            <button id="btnActivateFinger" class="btn-warning" style="display:none;">
              <img src="https://cdn-icons-png.flaticon.com/512/4698/4698218.png" alt="finger icon"/>
              Poder do Dedo (8)
            </button>
            <button id="btnRecordVideo" class="btn-dark">
              <img src="https://cdn-icons-png.flaticon.com/512/2920/2920273.png" alt="video icon"/>
              Gravar Vídeo
            </button>
          </div>

          <!-- OVERLAY DE VÍDEO -->
          <div id="videoOverlay">
            <video id="videoPreview" autoplay muted playsinline></video>
            <div style="margin-top:10px;">
              <button id="btnStartRecording" class="btn-success">
                <img src="https://cdn-icons-png.flaticon.com/512/727/727245.png" alt="record icon"/>
                Iniciar
              </button>
              <button id="btnStopRecording" class="btn-danger">
                <img src="https://cdn-icons-png.flaticon.com/512/1094/1094771.png" alt="stop icon"/>
                Parar
              </button>
              <button id="btnCloseVideoOverlay" class="btn-dark">
                <img src="https://cdn-icons-png.flaticon.com/512/463/463612.png" alt="close icon"/>
                Fechar
              </button>
            </div>
          </div>

          <h4 style="margin-top:15px;">Painel (Eventos)</h4>
          <div id="playerPainel" class="panel-box"></div>

          <h4>Chat</h4>
          <div id="playerChat" class="chat-box"></div>
          <input type="text" id="playerChatInput" placeholder="Digite uma mensagem..." />
          <button id="btnPlayerSendChat" class="btn-info" style="margin-top:5px;">
            <img src="https://cdn-icons-png.flaticon.com/512/3048/3048122.png" alt="chat icon"/>
            Enviar
          </button>
        </div>
      </div>
    </div><!-- contentScroll -->
  </div><!-- mainContainer -->

<script>
/************ CONFIG DO FIREBASE ************/
const firebaseConfig = {
  apiKey: "AIzaSyBQ5czr0wUqNxyqU9X_WHO3DrHOYEAPf7M",
  authDomain: "opoderdodedo.firebaseapp.com",
  databaseURL: "https://opoderdodedo-default-rtdb.firebaseio.com",
  projectId: "opoderdodedo",
  storageBucket: "opoderdodedo.firebasestorage.app",
  messagingSenderId: "931089125837",
  appId: "1:931089125837:web:fa22ae36bd206f28cf7484",
  measurementId: "G-6YE1KQ0VQC"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

/****************** IDs DO DOM ******************/
/* (Mesmo script do final anterior, mas com
   duas adições:
   1) Limpar localStorage ao encerrar partida (host).
   2) Limpar localStorage ao digitar novo código (player). 
*/

// ... (Mesma Lógica)...

/****************** MODO SELETOR *****************/
const modeSelect= document.getElementById('modeSelect');
const btnHost= document.getElementById('btnHost');
const btnPlayer= document.getElementById('btnPlayer');

btnHost.onclick= ()=>{
  modeSelect.classList.add('hidden');
  document.getElementById('hostArea').classList.remove('hidden');
};
btnPlayer.onclick= ()=>{
  modeSelect.classList.add('hidden');
  document.getElementById('playerArea').classList.remove('hidden');
};

/****************** FUNÇÕES DE HOST ******************/
/* ... (igual) ... */

let gameCode=null;
let myPlayerKey=null; 
let localCameraStream=null; 
let mediaRecorder=null; 
let recordedChunks=[];

const hostStep1= document.getElementById('hostStep1');
const btnCreateGame= document.getElementById('btnCreateGame');
const btnJoinGameHost= document.getElementById('btnJoinGameHost');
const inputGameCodeHost= document.getElementById('inputGameCodeHost');

const hostLobby= document.getElementById('hostLobby');
const hostGame= document.getElementById('hostGame');
const hostGameCode= document.getElementById('hostGameCode');
const qrCodeLobby= document.getElementById('qrCodeLobby');
const hostLinkInfo= document.getElementById('hostLinkInfo');
const hostPlayersList= document.getElementById('hostPlayersList');
const btnStartGame= document.getElementById('btnStartGame');

const hostStatusPanel= document.getElementById('hostStatusPanel');
const btnDrawCard= document.getElementById('btnDrawCard');
const deckCount= document.getElementById('deckCount');
const deckView= document.getElementById('deckView');
const currentCardHost= document.getElementById('currentCardHost');
const hostRules= document.getElementById('hostRules');
const hostPlayersStatus= document.getElementById('hostPlayersStatus');
const hostPainel= document.getElementById('hostPainel');
const hostChat= document.getElementById('hostChat');
const hostChatInput= document.getElementById('hostChatInput');
const btnHostSendChat= document.getElementById('btnHostSendChat');
const btnEndGame= document.getElementById('btnEndGame');

btnCreateGame.onclick= createGameAsHost;
btnJoinGameHost.onclick= joinGameAsHost;
btnStartGame.onclick= startGameHost;
btnDrawCard.onclick= drawCardHost;
btnEndGame.onclick= endGameHost;
btnHostSendChat.onclick= sendChatAsHost;

async function createGameAsHost(){
  gameCode= generateGameCode();
  const deck= generateDeck();
  const initialData= {
    status:'lobby',
    players:{},
    deck,
    currentCard:null,
    currentPlayerIndex:0,
    direction:1,
    rules:[],
    logs:[],
    fingerPower:{active:false,owner:null,queue:[]},
    chat:[]
  };
  await db.ref(`games/${gameCode}`).set(initialData);

  showHostLobby(gameCode);
  subscribeHost(gameCode);
}
async function joinGameAsHost(){
  const code= inputGameCodeHost.value.trim();
  if(!code)return alert("Digite um código!");
  // Limpamos localStorage se quiser remover coisas antigas
  localStorage.clear();

  const snap= await db.ref(`games/${code}`).once('value');
  if(!snap.exists()){
    alert("Partida não encontrada!");
    return;
  }
  gameCode= code;
  showHostLobby(code);
  subscribeHost(code);
}
function showHostLobby(code){
  hostStep1.classList.add('hidden');
  hostLobby.classList.remove('hidden');
  hostGameCode.textContent= code;
  qrCodeLobby.innerHTML='';
  new QRCode(qrCodeLobby, {
    text: location.origin+ location.pathname+`?gameId=${code}`,
    width:160,
    height:160
  });
  hostLinkInfo.textContent= `Link: ${location.origin+location.pathname}?gameId=${code}`;
}
function subscribeHost(code){
  db.ref(`games/${code}`).on('value', snap=>{
    if(!snap.exists())return;
    const data= snap.val();
    if(data.status==='lobby'){
      renderHostLobby(data);
    } else if(data.status==='ongoing'){
      hostLobby.classList.add('hidden');
      hostGame.classList.remove('hidden');
      renderHostGame(data);
    } else if(data.status==='finished'){
      alert("Partida Encerrada!");
    }
  });
}
function renderHostLobby(data){
  const arr= Object.values(data.players||{});
  hostPlayersList.innerHTML= arr.map(p=> `<div>${p.name}</div>`).join('');
}
function startGameHost(){
  db.ref(`games/${gameCode}`).update({status:'ongoing'});
}
function renderHostGame(data){
  const arr= Object.values(data.players||{});
  const currName= arr[data.currentPlayerIndex]?.name||'???';
  hostStatusPanel.textContent= `É a vez de: ${currName}`;

  const qrCodeGame= document.getElementById('qrCodeGame');
  qrCodeGame.innerHTML='';
  new QRCode(qrCodeGame, {
    text: location.origin+location.pathname+`?gameId=${gameCode}`,
    width:120,
    height:120
  });

  deckCount.textContent= `Restantes: ${data.deck? data.deck.length:0}`;
  deckView.innerHTML= (data.deck||[]).map(()=>`<div class="card-back"></div>`).join('');

  if(data.currentCard){
    currentCardHost.innerHTML= renderCard(data.currentCard.rank, data.currentCard.suit);
  }else{
    currentCardHost.textContent="Nenhuma";
  }

  if(data.rules && data.rules.length>0){
    hostRules.innerHTML= data.rules.map(r=>`<div class="rule-item">${r}</div>`).join('');
  }else{
    hostRules.textContent="Nenhuma";
  }

  hostPlayersStatus.innerHTML= arr.map((p,i)=>{
    const isCurrent= (i===data.currentPlayerIndex)?' (Vez)':'';
    const coringas= p.jokers>0? ` [Coringas: ${p.jokers}]`:'';
    return `<div><strong>${p.name}</strong>${isCurrent}${coringas}</div>`;
  }).join('');

  if(data.logs){
    hostPainel.innerHTML= data.logs.map(l=>`<div>${l}</div>`).join('');
    hostPainel.scrollTop= hostPainel.scrollHeight;
  }
  if(data.chat){
    hostChat.innerHTML= data.chat.map(c=>`<div><strong>${c.from}:</strong> ${c.text}</div>`).join('');
    hostChat.scrollTop= hostChat.scrollHeight;
  }
}
async function drawCardHost(){
  const snap= await db.ref(`games/${gameCode}`).once('value');
  const gameData= snap.val();
  if(!gameData.deck || gameData.deck.length===0){
    addLog("Baralho acabou!");
    return;
  }
  const card= gameData.deck[0];
  const newDeck= gameData.deck.slice(1);
  handleCardEffect(card, gameData);
  await db.ref(`games/${gameCode}`).update({
    deck:newDeck, currentCard:card
  });
}
function endGameHost(){
  db.ref(`games/${gameCode}`).update({status:'finished'});
  // Limpamos localStorage do host
  localStorage.clear();
}

/********************* CHAT HOST *********************/
function sendChatAsHost(){
  const txt= hostChatInput.value.trim();
  if(!txt)return;
  hostChatInput.value='';
  db.ref(`games/${gameCode}/chat`).once('value', snap=>{
    let arr= snap.val()||[];
    arr.push({ from:'HOST', text:txt, ts:Date.now()});
    db.ref(`games/${gameCode}/chat`).set(arr);
  });
}

/********************* EFEITOS DE CARTA *********************/
function handleCardEffect(card, gameData){
  let logs= gameData.logs||[];
  const arr= Object.values(gameData.players||{});
  let idx= gameData.currentPlayerIndex;
  let direction= gameData.direction;
  let rules= gameData.rules||[];
  const currName= arr[idx]?.name||'???';
  logs.push(`${currName} puxou [${card.rank}${card.suit!=='Coringa'?card.suit:''}]`);

  let passTurn=true;
  switch(card.rank){
    case '4':
      const newRule= prompt("Nova regra?");
      if(newRule){
        rules.push(newRule);
        logs.push(`Regra adicionada: "${newRule}"`);
      }
      break;
    case '6':
      rules=[];
      logs.push("Todas as regras foram quebradas!");
      break;
    case '8':
      const pKey= Object.keys(gameData.players||{})[idx];
      if(pKey){
        db.ref(`games/${gameCode}/players/${pKey}/hasFingerPower`).set(true);
        logs.push(`${currName} obteve o Poder do Dedo!`);
      }
      break;
    case '9':
      direction *= -1;
      logs.push("O sentido foi invertido!");
      break;
    case '10':
      passTurn=false;
      setTimeout(()=>{
        let ni= idx+direction;
        if(ni<0) ni= arr.length-1;
        if(ni>=arr.length) ni=0;
        ni+=direction;
        if(ni<0) ni= arr.length-1;
        if(ni>=arr.length) ni=0;
        db.ref(`games/${gameCode}`).update({
          currentPlayerIndex: ni, direction, rules, logs
        });
      },500);
      break;
    case 'J':
      logs.push(`${currName} bebe 1 dose!`);
      sendDrinkAlert(idx, gameData);
      break;
    case 'Q':
      logs.push("Todas as mulheres bebem 1 dose!");
      break;
    case 'K':
      logs.push("Todos os homens bebem 1 dose!");
      break;
    case 'Joker':
      const jkKey= Object.keys(gameData.players||{})[idx];
      if(jkKey){
        const oldVal= arr[idx].jokers||0;
        db.ref(`games/${gameCode}/players/${jkKey}/jokers`).set(oldVal+1);
        logs.push(`${currName} ganhou 1 Coringa!`);
      }
      break;
    default:
      // A,2,3,5,7 ...
  }

  if(passTurn && card.rank!=='10'){
    let ni= idx+direction;
    if(ni<0) ni= arr.length-1;
    if(ni>=arr.length) ni=0;
    db.ref(`games/${gameCode}`).update({
      currentPlayerIndex: ni, direction, rules, logs
    });
  } else {
    db.ref(`games/${gameCode}`).update({ direction, rules, logs });
  }
}
function sendDrinkAlert(playerIndex, gameData){
  const pKey= Object.keys(gameData.players||{})[playerIndex];
  if(!pKey)return;
  db.ref(`games/${gameCode}/players/${pKey}/needsToDrink`).set(Date.now());
}

/**************** MODO JOGADOR ****************/
(function checkUrlForGameId(){
  const params= new URLSearchParams(location.search);
  if(params.has('gameId')){
    const code= params.get('gameId');
    if(code){
      modeSelect.classList.add('hidden');
      playerArea.classList.remove('hidden');
      inputGameCodePlayer.value=code;
      enterCodePlayer();
    }
  }
})();

const playerArea= document.getElementById('playerArea');
const playerStep1= document.getElementById('playerStep1');
const inputGameCodePlayer= document.getElementById('inputGameCodePlayer');
const btnEnterCodePlayer= document.getElementById('btnEnterCodePlayer');

const playerRegister= document.getElementById('playerRegister');
const inputPlayerName= document.getElementById('inputPlayerName');
const btnJoinPlayerGame= document.getElementById('btnJoinPlayerGame');

const playerLobby= document.getElementById('playerLobby');
const playerLobbyList= document.getElementById('playerLobbyList');
const playerGame= document.getElementById('playerGame');
const playerStatusPanel= document.getElementById('playerStatusPanel');
const currentCardPlayer= document.getElementById('currentCardPlayer');
const btnDrawCardPlayer= document.getElementById('btnDrawCardPlayer');
const deckCountPlayer= document.getElementById('deckCountPlayer');
const deckViewPlayer= document.getElementById('deckViewPlayer');
const playerRules= document.getElementById('playerRules');
const playerListStatus= document.getElementById('playerListStatus');
const fingerBox= document.getElementById('fingerBox');
const btnFingerClick= document.getElementById('btnFingerClick');
const btnUseJoker= document.getElementById('btnUseJoker');
const btnActivateFinger= document.getElementById('btnActivateFinger');
const btnRecordVideo= document.getElementById('btnRecordVideo');
const playerPainel= document.getElementById('playerPainel');
const playerChat= document.getElementById('playerChat');
const playerChatInput= document.getElementById('playerChatInput');
const btnPlayerSendChat= document.getElementById('btnPlayerSendChat');
const videoOverlay= document.getElementById('videoOverlay');
const videoPreview= document.getElementById('videoPreview');
const btnStartRecording= document.getElementById('btnStartRecording');
const btnStopRecording= document.getElementById('btnStopRecording');
const btnCloseVideoOverlay= document.getElementById('btnCloseVideoOverlay');

btnEnterCodePlayer.onclick= enterCodePlayer;
btnJoinPlayerGame.onclick= registerPlayerInGame;
btnDrawCardPlayer.onclick= drawCardPlayer;
btnFingerClick.onclick= fingerClick;
btnUseJoker.onclick= useJokerPlayer;
btnActivateFinger.onclick= activateFingerPower;
btnRecordVideo.onclick= ()=>videoOverlay.style.display='flex';
btnCloseVideoOverlay.onclick= closeVideoOverlay;
btnStartRecording.onclick= startVideoRecording;
btnStopRecording.onclick= stopVideoRecording;
btnPlayerSendChat.onclick= sendChatAsPlayer;

function enterCodePlayer(){
  const code= inputGameCodePlayer.value.trim();
  if(!code)return alert("Digite um código!");
  // Limpamos localStorage para não trazer dados de partida anterior
  localStorage.clear();

  db.ref(`games/${code}`).once('value', snap=>{
    if(!snap.exists()){
      alert("Partida não encontrada!");
      return;
    }
    gameCode= code;
    playerStep1.classList.add('hidden');
    playerRegister.classList.remove('hidden');
  });
}
async function registerPlayerInGame(){
  const name= inputPlayerName.value.trim();
  if(!name)return alert("Digite seu nome!");

  const ref= db.ref(`games/${gameCode}/players`).push();
  myPlayerKey= ref.key;
  await ref.set({ name, jokers:0, hasFingerPower:false });

  localStorage.setItem("opoderdedo_gameId", gameCode);
  localStorage.setItem("opoderdedo_playerKey", myPlayerKey);
  localStorage.setItem("opoderdedo_playerName", name);

  db.ref(`games/${gameCode}`).on('value', snapshot=>{
    if(!snapshot.exists())return;
    updatePlayerView(snapshot.val());
  });
  playerRegister.classList.add('hidden');
}
function updatePlayerView(data){
  if(data.status==='lobby'){
    playerLobby.classList.remove('hidden');
    playerGame.classList.add('hidden');
    const arr= Object.values(data.players||{});
    playerLobbyList.innerHTML= arr.map(p=>`<div>${p.name}</div>`).join('');
  }
  else if(data.status==='ongoing'){
    playerLobby.classList.add('hidden');
    playerGame.classList.remove('hidden');

    const pObj= data.players?.[myPlayerKey];
    if(!pObj){
      playerStatusPanel.textContent= "Você não está no jogo?";
      playerStatusPanel.classList.remove('hidden');
      return;
    }
    // Lista de players
    const arr= Object.values(data.players||{});
    playerListStatus.innerHTML= arr.map((pp,i)=>{
      const isCurrent= (i===data.currentPlayerIndex)?' (Vez)':'';
      const coringa= pp.jokers>0? ` [Coringas: ${pp.jokers}]`:'';
      return `<div><strong>${pp.name}</strong>${isCurrent}${coringa}</div>`;
    }).join('');

    // Deck
    deckCountPlayer.textContent= `Restantes: ${data.deck?data.deck.length:0}`;
    deckViewPlayer.innerHTML= (data.deck||[]).map(()=>`<div class="card-back"></div>`).join('');

    // Carta atual
    if(data.currentCard){
      currentCardPlayer.innerHTML= renderCard(data.currentCard.rank, data.currentCard.suit);
    } else {
      currentCardPlayer.textContent="Nenhuma";
    }

    // Regras
    if(data.rules && data.rules.length>0){
      playerRules.innerHTML= data.rules.map(r=>`<div class="rule-item">${r}</div>`).join('');
    } else {
      playerRules.textContent="Nenhuma";
    }

    // Quem é o atual
    const keys= Object.keys(data.players||{});
    if(keys[data.currentPlayerIndex]===myPlayerKey){
      playerStatusPanel.classList.remove('hidden');
      playerStatusPanel.style.color="#28a745";
      playerStatusPanel.textContent="É A SUA VEZ!";
      btnDrawCardPlayer.style.display='inline-block';
    } else {
      const cName= arr[data.currentPlayerIndex]?.name||'???';
      playerStatusPanel.classList.remove('hidden');
      playerStatusPanel.style.color="#007BFF";
      playerStatusPanel.textContent=`É a vez de: ${cName}`;
      btnDrawCardPlayer.style.display='none';
    }

    // Poder do Dedo? 
    btnActivateFinger.style.display= pObj.hasFingerPower?'inline-block':'none';
    btnUseJoker.style.display= pObj.jokers>0?'inline-block':'none';

    // Finger Power global
    if(data.fingerPower && data.fingerPower.active){
      fingerBox.classList.remove('hidden');
      const found= (data.fingerPower.queue||[]).find(x=> x.playerKey===myPlayerKey);
      if(found){
        btnFingerClick.disabled=true;
        btnFingerClick.textContent="Você já clicou!";
      } else {
        btnFingerClick.disabled=false;
        btnFingerClick.textContent="Clique agora!";
      }
      fingerQueue.innerHTML= (data.fingerPower.queue||[]).map((x,i)=>`${i+1}º: ${x.name}`).join('<br>');
    } else {
      fingerBox.classList.add('hidden');
    }

    // Painel
    if(data.logs){
      playerPainel.innerHTML= data.logs.map(l=>`<div>${l}</div>`).join('');
      playerPainel.scrollTop= playerPainel.scrollHeight;
    }
    // Chat
    if(data.chat){
      playerChat.innerHTML= data.chat.map(c=>`<div><strong>${c.from}:</strong> ${c.text}</div>`).join('');
      playerChat.scrollTop= playerChat.scrollHeight;
    }

    // needsToDrink
    if(pObj.needsToDrink){
      alert("Você precisa beber!");
      db.ref(`games/${gameCode}/players/${myPlayerKey}/needsToDrink`).remove();
    }
  }
  else if(data.status==='finished'){
    alert("Partida Encerrada!");
    // limpamos localStorage do player
    localStorage.clear();
  }
}
async function drawCardPlayer(){
  const snap= await db.ref(`games/${gameCode}`).once('value');
  const data= snap.val();
  if(!data)return;
  const keys= Object.keys(data.players||{});
  if(keys[data.currentPlayerIndex]!== myPlayerKey){
    alert("Não é sua vez de puxar a carta!");
    return;
  }
  if(!data.deck || data.deck.length===0){
    addLog("Baralho acabou!");
    return;
  }
  const card= data.deck[0];
  const newDeck= data.deck.slice(1);
  handleCardEffect(card, data);
  await db.ref(`games/${gameCode}`).update({
    deck:newDeck, currentCard:card
  });
}

/********** CORINGA, PODER DO DEDO (PLAYER) **********/
function useJokerPlayer(){
  db.ref(`games/${gameCode}/players/${myPlayerKey}`).once('value', snap=>{
    const p= snap.val();
    if(!p)return;
    if(p.jokers>0){
      db.ref(`games/${gameCode}/players/${myPlayerKey}/jokers`).set(p.jokers-1);
      addLog(`${p.name} usou 1 Coringa para não beber!`);
    }
  });
}
function activateFingerPower(){
  const name= localStorage.getItem("opoderdedo_playerName")|| 'Jogador';
  db.ref(`games/${gameCode}/fingerPower`).set({
    active:true, 
    owner:myPlayerKey,
    queue:[{playerKey:myPlayerKey, name}]
  });
  db.ref(`games/${gameCode}/players/${myPlayerKey}/hasFingerPower`).set(false);
  addLog(`${name} ativou o Poder do Dedo!`);
}
function fingerClick(){
  db.ref(`games/${gameCode}/fingerPower/queue`).once('value', snap=>{
    let arr= snap.val()||[];
    if(arr.find(x=> x.playerKey===myPlayerKey))return;
    const name= localStorage.getItem("opoderdedo_playerName")|| 'Jogador';
    arr.push({playerKey:myPlayerKey, name});
    db.ref(`games/${gameCode}/fingerPower/queue`).set(arr);
  });
}

/********** GRAVAÇÃO VÍDEO **********/
async function startVideoRecording(){
  try{
    if(!localCameraStream){
      localCameraStream= await navigator.mediaDevices.getUserMedia({video:true, audio:true});
      videoPreview.srcObject= localCameraStream;
    }
    recordedChunks=[];
    mediaRecorder= new MediaRecorder(localCameraStream);
    mediaRecorder.ondataavailable= e=>{
      if(e.data.size>0) recordedChunks.push(e.data);
    };
    mediaRecorder.onstop= async ()=>{
      if(recordedChunks.length>0){
        const blob= new Blob(recordedChunks,{type:'video/mp4'});
        const ref= storage.ref(`games/${gameCode}/videos/${Date.now()}.mp4`);
        await ref.put(blob);
        const url= await ref.getDownloadURL();
        addLog(`Gravou Vídeo! URL: ${url}`);
      }
    };
    mediaRecorder.start();
    addLog("Iniciou gravação de vídeo...");
  } catch(err){
    alert("Não foi possível acessar câmera: "+err);
  }
}
function stopVideoRecording(){
  if(mediaRecorder && mediaRecorder.state==='recording'){
    mediaRecorder.stop();
    addLog("Parou gravação de vídeo.");
  }
}
function closeVideoOverlay(){
  videoOverlay.style.display='none';
  if(localCameraStream){
    localCameraStream.getTracks().forEach(t=> t.stop());
    localCameraStream=null;
  }
  videoPreview.srcObject=null;
}

/********** CHAT (PLAYER) **********/
function sendChatAsPlayer(){
  const txt= playerChatInput.value.trim();
  if(!txt)return;
  playerChatInput.value='';
  db.ref(`games/${gameCode}/chat`).once('value', snap=>{
    let arr= snap.val()||[];
    const name= localStorage.getItem("opoderdedo_playerName")|| 'Jogador';
    arr.push({from:name, text:txt, ts:Date.now()});
    db.ref(`games/${gameCode}/chat`).set(arr);
  });
}

/********** LOG HELPER **********/
function addLog(msg){
  db.ref(`games/${gameCode}/logs`).once('value', snap=>{
    let arr= snap.val()||[];
    arr.push(msg);
    db.ref(`games/${gameCode}/logs`).set(arr);
  });
}

/********** GERA CODE E BARALHO **********/
function generateGameCode(){
  return Math.floor(100000 + Math.random()*900000).toString();
}
function generateDeck(){
  const suits= ["♥","♦","♣","♠"];
  const ranks=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
  let deck=[];
  for(let s of suits){
    for(let r of ranks){
      deck.push({rank:r, suit:s});
    }
  }
  for(let i=0;i<3;i++){
    deck.push({rank:'Joker', suit:'Coringa'});
  }
  for(let i=deck.length-1;i>0;i--){
    const j= Math.floor(Math.random()*(i+1));
    [deck[i], deck[j]]= [deck[j], deck[i]];
  }
  return deck;
}
function renderCard(rank, suit){
  if(rank==='Joker'){
    return `
      <div class="card-front" style="background:#ffd700;">
        <div style="position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); font-size:1rem; color:#000;">
          CORINGA
        </div>
      </div>
    `;
  }
  const isRed= (suit==='♥'||suit==='♦');
  return `
    <div class="card-front">
      <div class="card-rank-suit ${isRed?'red':'black'}">
        ${rank}${suit}
      </div>
    </div>
  `;
}
</script>
</body>
</html>
