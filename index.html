<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>O Poder do Dedo - Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase compat (Realtime Database) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>
  <style>
    body {
      margin: 0; padding: 0;
      background: #222;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex; 
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      margin-top: 10px;
    }
    #joinArea, #gamePlay {
      width: 90%;
      max-width: 400px;
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #444;
      border-radius: 5px;
      background: #333;
    }
    label { display: block; margin-bottom: 5px; }
    input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 16px;
      background-color: #444;
      color: #fff;
      border: 1px solid #666;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .power-btn {
      background: #ffb600; 
      color: #000;
      border: 1px solid #444;
    }
    .player-info {
      margin-bottom: 10px;
    }
    .finger-box {
      background: #555;
      margin: 10px 0;
      padding: 10px;
    }
    .finger-box button {
      margin: 5px 0;
    }
    #currentCard {
      margin: 10px 0;
      text-align: center;
    }
    .card-front {
      width: 100px;
      height: 140px;
      background: #fff;
      border: 2px solid #000;
      border-radius: 5px;
      margin: 0 auto;
      position: relative;
      color: #000;
    }
    .card-rank-suit {
      position: absolute;
      top: 8px; left: 8px;
      font-size: 1.4rem;
      font-weight: bold;
    }
    .red { color: red; }
    .black { color: black; }
    #rulesList {
      margin-top: 10px;
    }
    #rulesList .rule-item {
      background: #444;
      margin: 4px 0;
      padding: 4px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <h1>O Poder do Dedo - Player</h1>

  <div id="joinArea">
    <label>Nome do jogador:</label>
    <input type="text" id="playerName" />
    <button id="btnJoin">Entrar no Jogo</button>
  </div>

  <div id="gamePlay" style="display:none;">
    <div class="player-info" id="playerInfo"></div>
    <div id="currentCard"></div>
    <div>
      <button id="btnUseJoker" style="display:none;">Usar Coringa</button>
      <button id="btnActivateFinger" class="power-btn" style="display:none;">
        Usar Poder do Dedo
      </button>
    </div>
    <div class="finger-box" id="fingerBox" style="display:none;">
      <h4>Poder do Dedo Ativo!</h4>
      <p>Toque aqui <strong>AGORA</strong> para não ser o último!</p>
      <button id="btnFingerClick">Clique Rápido!</button>
      <div id="fingerStatus"></div>
    </div>
    <div id="rulesList"></div>
  </div>

<script>
/**
 * CONFIG FIREBASE
 */
const firebaseConfig = {
  apiKey: "AIzaSyBQ5czr0wUqNxyqU9X_WHO3DrHOYEAPf7M",
  authDomain: "opoderdodedo.firebaseapp.com",
  databaseURL: "https://opoderdodedo-default-rtdb.firebaseio.com",
  projectId: "opoderdodedo",
  storageBucket: "opoderdodedo.firebasestorage.app",
  messagingSenderId: "931089125837",
  appId: "1:931089125837:web:fa22ae36bd206f28cf7484",
  measurementId: "G-6YE1KQ0VQC"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ------------------------------------------------
// ELEMENTOS
// ------------------------------------------------
const joinArea = document.getElementById('joinArea');
const gamePlay = document.getElementById('gamePlay');
const playerNameInput = document.getElementById('playerName');
const btnJoin = document.getElementById('btnJoin');

const playerInfoDiv = document.getElementById('playerInfo');
const currentCardDiv = document.getElementById('currentCard');
const btnUseJoker = document.getElementById('btnUseJoker');
const btnActivateFinger = document.getElementById('btnActivateFinger');
const fingerBox = document.getElementById('fingerBox');
const btnFingerClick = document.getElementById('btnFingerClick');
const fingerStatus = document.getElementById('fingerStatus');
const rulesList = document.getElementById('rulesList');

// ------------------------------------------------
// VARIÁVEIS
// ------------------------------------------------
const urlParams = new URLSearchParams(window.location.search);
const gameId = urlParams.get('gameId');
let myPlayerKey = null;
let localPlayerData = null; // {name, jokers, hasFingerPower, ...}

// ------------------------------------------------
// EVENTOS
// ------------------------------------------------
btnJoin.addEventListener('click', joinGame);
btnUseJoker.addEventListener('click', useJoker);
btnActivateFinger.addEventListener('click', activateFingerPower);
btnFingerClick.addEventListener('click', fingerClick);

// ------------------------------------------------
// ENTRAR NA PARTIDA
// ------------------------------------------------
function joinGame() {
  const name = playerNameInput.value.trim();
  if (!name) {
    alert("Digite seu nome!");
    return;
  }
  if (!gameId) {
    alert("Não há gameId na URL!");
    return;
  }

  // Cria um "player" no DB
  // players: { playerKey: { name, jokers, hasFingerPower } }
  const ref = db.ref(`games/${gameId}/players`).push();
  myPlayerKey = ref.key;

  const newPlayerData = {
    name,
    jokers: 0,
    hasFingerPower: false,
    idKey: myPlayerKey // guardamos a key dentro do objeto
  };
  ref.set(newPlayerData);

  // Esconde join e mostra a tela do jogo
  joinArea.style.display = 'none';
  gamePlay.style.display = 'block';

  // Ouvir mudanças do game
  db.ref(`games/${gameId}`).on('value', snapshot => {
    const data = snapshot.val();
    if (!data) return;
    updatePlayerView(data);
  });
}

// ------------------------------------------------
// ATUALIZAR TELA DO JOGADOR
// ------------------------------------------------
function updatePlayerView(gameData) {
  // Obter dados do meu player
  const myData = gameData.players?.[myPlayerKey];
  if (!myData) {
    // se eu não existir, talvez fui removido?
    return;
  }
  localPlayerData = myData;

  // Mostra info
  playerInfoDiv.textContent = `Olá, ${myData.name} | Coringas: ${myData.jokers || 0}`;

  // Mostra carta atual
  if (gameData.currentCard) {
    currentCardDiv.innerHTML = renderCardFront(gameData.currentCard.rank, gameData.currentCard.suit);
  } else {
    currentCardDiv.innerHTML = 'Nenhuma carta puxada ainda.';
  }

  // Regras
  const r = gameData.rules || [];
  if (r.length === 0) {
    rulesList.innerHTML = '<p>Nenhuma Regra Ativa</p>';
  } else {
    rulesList.innerHTML = '<h4>Regras Ativas:</h4>' + r.map(rule => {
      return `<div class="rule-item">${rule}</div>`;
    }).join('');
  }

  // Ver se posso usar coringa
  if (myData.jokers > 0) {
    btnUseJoker.style.display = 'inline-block';
  } else {
    btnUseJoker.style.display = 'none';
  }

  // Ver se tenho poder do dedo
  if (myData.hasFingerPower) {
    btnActivateFinger.style.display = 'inline-block';
  } else {
    btnActivateFinger.style.display = 'none';
  }

  // Gerenciar "fingerPower" global
  const fp = gameData.fingerPower || {};
  if (fp.active) {
    // mostrar a box de corrida
    fingerBox.style.display = 'block';
    // se eu já cliquei, desabilitar o botão
    const alreadyClicked = fp.queue?.find(x => x.playerKey === myPlayerKey);
    if (alreadyClicked) {
      btnFingerClick.disabled = true;
      btnFingerClick.textContent = "Você já clicou!";
    } else {
      btnFingerClick.disabled = false;
      btnFingerClick.textContent = "Clique Rápido!";
    }

    // Mostrar status da fila
    fingerStatus.innerHTML = fp.queue.map((item, i) => {
      return `${i+1}º: ${item.name}`;
    }).join('<br>');
  } else {
    // esconder
    fingerBox.style.display = 'none';
  }
  
  // Se status finished
  if (gameData.status === 'finished') {
    alert("Partida Encerrada!");
  }
}

// ------------------------------------------------
// USAR CORINGA
// ------------------------------------------------
function useJoker() {
  if (!localPlayerData) return;
  if (localPlayerData.jokers <= 0) {
    alert("Você não tem coringa.");
    return;
  }
  // ao usar coringa, decrementa 1
  const newVal = localPlayerData.jokers - 1;
  db.ref(`games/${gameId}/players/${myPlayerKey}/jokers`).set(newVal);
  // poderia registrar log
  addLog(`${localPlayerData.name} usou 1 Coringa e não bebeu!`);
}

// ------------------------------------------------
// ATIVAR PODER DO DEDO
// ------------------------------------------------
function activateFingerPower() {
  // Marca no DB que fingerPower está ativo e define quem "puxou"
  // Reseta a queue
  db.ref(`games/${gameId}/fingerPower`).set({
    active: true,
    owner: myPlayerKey,
    queue: [{ playerKey: myPlayerKey, name: localPlayerData.name }]
  });
  // Remove o hasFingerPower do player
  db.ref(`games/${gameId}/players/${myPlayerKey}/hasFingerPower`).set(false);

  addLog(`${localPlayerData.name} USOU o Poder do Dedo!`);
  alert("Poder do Dedo ativado! Todos precisam clicar rápido pra não perder!");
}

// ------------------------------------------------
// JOGADOR CLICA NO DEDO
// ------------------------------------------------
function fingerClick() {
  // Adiciona meu player na fila, se ainda não estiver
  db.ref(`games/${gameId}/fingerPower/queue`).once('value', snap => {
    let queue = snap.val() || [];
    if (queue.find(x => x.playerKey === myPlayerKey)) {
      // já estou na fila
      return;
    }
    queue.push({ playerKey: myPlayerKey, name: localPlayerData.name });
    db.ref(`games/${gameId}/fingerPower/queue`).set(queue);

    // Precisaríamos de uma lógica de "fechamento" depois de X segundos,
    // ou quando todos clicarem. Por ex.:
    if (queue.length === Object.keys((snap.val() || {})).length) {
      // se for igual a todos os players, finaliza.
      checkFingerPowerResult(queue);
    } else {
      // Ou a gente configura um timeout no Host pra encerrar a corrida.
    }
  });
}

// ------------------------------------------------
// CHECAR RESULTADO DO PODER DO DEDO
// (poderia rodar no Host depois de X segundos)
// ------------------------------------------------
function checkFingerPowerResult(queue) {
  // O último da fila é o perdedor
  const last = queue[queue.length - 1];
  if (!last) return;

  // Manda log
  addLog(`O último a clicar foi ${last.name}, então ${last.name} bebe!`);
  // Se quiser mandar um "alert" só pra ele no local, dá pra setar algo como
  // db.ref(`games/${gameId}/players/${last.playerKey}/needsToDrink`).set(true);

  // Desativar o fingerPower
  db.ref(`games/${gameId}/fingerPower`).update({
    active: false
  });
}

// ------------------------------------------------
// Helper: Adiciona log
// ------------------------------------------------
function addLog(msg) {
  const logsRef = db.ref(`games/${gameId}/logs`);
  logsRef.once('value', snap => {
    let arr = snap.val() || [];
    arr.push(msg);
    logsRef.set(arr);
  });
}

// ------------------------------------------------
// Render carta
// ------------------------------------------------
function renderCardFront(rank, suit) {
  if (rank === 'Joker') {
    return `
      <div class="card-front" style="background:#ffd700;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1rem;color:#000;">
          CORINGA
        </div>
      </div>
    `;
  }
  const isRed = (suit === '♥' || suit === '♦');
  const colorClass = isRed ? 'red' : 'black';
  return `
    <div class="card-front">
      <div class="card-rank-suit ${colorClass}">
        ${rank}${suit}
      </div>
    </div>
  `;
}
</script>
</body>
</html>
