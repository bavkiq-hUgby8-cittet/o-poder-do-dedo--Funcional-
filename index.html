<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>O Poder do Dedo - Responsivo 16:9 com Firebase Config</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-storage-compat.js"></script>

  <!-- QRCode lib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    /* ========== ESTILOS BÁSICOS ========== */
    * {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
    }
    body, html {
      width: 100%; 
      height: 100%;
      background: #f0f0f0; 
      font-family: Arial, sans-serif;
      display: flex; 
      flex-direction: column;
      align-items: center;
    }

    /* Aspect Ratio para TV/notebook ou celular */
    #mainContainer {
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
      aspect-ratio: 16/9; /* Landscape */
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    @media (orientation: portrait) {
      #mainContainer {
        aspect-ratio: 9/16; /* Celular em pé */
      }
    }
    #contentScroll {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex; 
      flex-direction: column;
      gap: 20px;
    }

    h1 {
      text-align: center;
      margin: 10px 0;
      font-size: 1.5rem;
      color: #444;
    }

    .hidden { display: none !important; }

    .section {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .title {
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
      color: #444;
    }

    button {
      padding: 10px 14px;
      border: none;
      border-radius: 5px;
      margin: 5px 0;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    button:hover {
      opacity: 0.9;
    }
    .btn-dark    { background: #555; color: #fff; }
    .btn-primary { background: #007BFF; color: #fff; }
    .btn-success { background: #28a745; color: #fff; }
    .btn-danger  { background: #dc3545; color: #fff; }
    .btn-warning { background: #ffc107; color: #212529; }
    .btn-info    { background: #17a2b8; color: #fff; }

    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .status-panel {
      background: #e7f3ff;
      border: 1px solid #bee0ff;
      border-radius: 5px;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      color: #007BFF;
      margin-bottom: 10px;
    }

    /* Painel (Eventos) com destaque */
    .panel-box {
      background: #fefff8;
      border: 2px solid #c5e3a4;
      border-radius: 5px;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      margin-top: 8px;
      color: #2c3e50;
      font-weight: bold;
    }
    /* Chat e Regras */
    .chat-box {
      background: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 5px;
      max-height: 150px;
      overflow-y: auto;
      padding: 10px;
      margin-top: 8px;
    }
    .rules-box {
      background: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      min-height: 60px;
    }
    .rule-item {
      background: #eee;
      margin: 4px 0;
      padding: 4px;
      border-radius: 3px;
    }

    /* Cartas e Baralho */
    .card-front {
      width: 100px; 
      height: 140px;
      border: 2px solid #000;
      border-radius: 6px;
      background: #fff;
      margin: 5px auto;
      position: relative;
      color: #000;
    }
    .card-rank-suit {
      position: absolute; 
      top:8px; left:8px; 
      font-size:1.4rem; 
      font-weight:bold;
    }
    .red { color: red; }
    .black { color: #000; }
    .card-back {
      width: 15px; 
      height:25px;
      background: #bbb;
      border-radius:3px;
      display:inline-block;
      margin:2px;
    }
    #deckView, #deckViewPlayer {
      display: flex; 
      flex-wrap: wrap; 
      max-width:80px; 
      margin-top:5px;
    }

    .finger-box {
      background: #fffde7;
      border: 1px solid #eee27f;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
    }

    #videoOverlay {
      position: fixed; 
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.8);
      color:#fff;
      display:none;
      flex-direction:column; 
      align-items:center; 
      justify-content:center;
      z-index:9999;
      padding:10px;
    }
    video {
      background:#000; 
      max-width:90vw; 
      max-height:60vh;
    }
  </style>
</head>

<body>
  <div id="mainContainer">
    <div id="contentScroll">
      <h1>O Poder do Dedo</h1>

      <!-- ========== MODO SELETOR ========== -->
      <div id="modeSelect" class="section">
        <div class="title">Você é o Organizador ou Jogador?</div>
        <button id="btnHost" class="btn-dark">Organizador</button>
        <button id="btnPlayer" class="btn-primary">Jogador</button>
      </div>

      <!-- ========== HOST AREA ========== -->
      <div id="hostArea" class="hidden">
        <div id="hostStep1" class="section">
          <div class="title">Criar ou Entrar numa Partida</div>
          <button id="btnCreateGame" class="btn-success">Criar Nova Partida</button>
          <p style="margin-top:10px;text-align:center;">Ou entre numa partida existente:</p>
          <input type="text" id="inputGameCodeHost" placeholder="Código..." />
          <button id="btnJoinGameHost" class="btn-info">Entrar</button>
        </div>

        <div id="hostLobby" class="hidden section">
          <div class="title">Lobby da Partida</div>
          <p>Código: <span id="hostGameCode"></span></p>
          <div style="text-align:center;">
            <div id="qrCodeLobby"></div>
            <p id="hostLinkInfo" style="margin-top:5px;font-size:0.9rem;"></p>
          </div>
          <h4 style="margin-top:10px;">Jogadores Conectados</h4>
          <div id="hostPlayersList"></div>
          <button id="btnStartGame" class="btn-primary" style="margin-top:10px;">
            Iniciar Partida
          </button>
        </div>

        <div id="hostGame" class="hidden section">
          <div id="hostStatusPanel" class="status-panel"></div>
          <div style="text-align:center;margin-bottom:10px;" id="qrCodeGame"></div>

          <h4>Carta Atual</h4>
          <div id="currentCardHost">Nenhuma</div>
          <button id="btnDrawCard" class="btn-warning" style="margin-top:8px;">
            Puxar Carta
          </button>

          <h4 style="margin-top:15px;">Baralho</h4>
          <div id="deckCount"></div>
          <div id="deckView"></div>

          <h4 style="margin-top:15px;">Regras Ativas</h4>
          <div id="hostRules" class="rules-box"></div>

          <h4 style="margin-top:15px;">Jogadores</h4>
          <div id="hostPlayersStatus"></div>

          <h4 style="margin-top:15px;">Painel (Eventos)</h4>
          <div id="hostPainel" class="panel-box"></div>

          <h4>Chat</h4>
          <div id="hostChat" class="chat-box"></div>
          <input type="text" id="hostChatInput" placeholder="Digite uma mensagem..." />
          <button id="btnHostSendChat" class="btn-info" style="margin-top:5px;">
            Enviar
          </button>

          <button id="btnEndGame" class="btn-danger" style="margin-top:10px;">
            Encerrar Partida
          </button>
        </div>
      </div>

      <!-- ========== PLAYER AREA ========== -->
      <div id="playerArea" class="hidden">
        <div id="playerStep1" class="section">
          <div class="title">Entrar Numa Partida</div>
          <input type="text" id="inputGameCodePlayer" placeholder="Código..." />
          <button id="btnEnterCodePlayer" class="btn-info" style="margin-top:8px;">
            Entrar
          </button>
          <p style="margin-top:8px;font-size:0.8rem;text-align:center;">ou use o QR Code</p>
        </div>

        <div id="playerRegister" class="hidden section">
          <div class="title">Digite Seu Nome</div>
          <input type="text" id="inputPlayerName" placeholder="Seu nome..." />
          <button id="btnJoinPlayerGame" class="btn-success" style="margin-top:8px;">
            Entrar na Partida
          </button>
        </div>

        <div id="playerLobby" class="hidden section">
          <div class="title">Aguardando Organizador Iniciar...</div>
          <div id="playerLobbyList"></div>
        </div>

        <div id="playerGame" class="hidden section">
          <div id="playerStatusPanel" class="status-panel hidden"></div>

          <h4>Carta Atual</h4>
          <div id="currentCardPlayer">Nenhuma</div>
          <button id="btnDrawCardPlayer" class="btn-warning" style="display:none; margin-top:8px;">
            Puxar Carta
          </button>

          <h4 style="margin-top:15px;">Baralho</h4>
          <div id="deckCountPlayer"></div>
          <div id="deckViewPlayer"></div>

          <h4 style="margin-top:15px;">Regras Ativas</h4>
          <div id="playerRules" class="rules-box"></div>

          <h4 style="margin-top:15px;">Jogadores</h4>
          <div id="playerListStatus"></div>

          <div class="finger-box hidden" id="fingerBox">
            <h4>Poder do Dedo Ativo!</h4>
            <p>Seja rápido para não perder!</p>
            <button id="btnFingerClick" class="btn-danger" style="margin-top:5px;">
              Clique agora!
            </button>
            <div id="fingerQueue" style="margin-top:5px;"></div>
          </div>

          <div style="text-align:center;">
            <button id="btnUseJoker" class="btn-info" style="display:none;">Usar Coringa</button>
            <button id="btnActivateFinger" class="btn-warning" style="display:none;">
              Poder do Dedo (8)
            </button>
            <button id="btnRecordVideo" class="btn-dark">
              Gravar Vídeo
            </button>
          </div>

          <!-- OVERLAY DE VÍDEO -->
          <div id="videoOverlay">
            <video id="videoPreview" autoplay muted playsinline></video>
            <div style="margin-top:10px;">
              <button id="btnStartRecording" class="btn-success">
                Iniciar
              </button>
              <button id="btnStopRecording" class="btn-danger">
                Parar
              </button>
              <button id="btnCloseVideoOverlay" class="btn-dark">
                Fechar
              </button>
            </div>
          </div>

          <h4 style="margin-top:15px;">Painel (Eventos)</h4>
          <div id="playerPainel" class="panel-box"></div>

          <h4>Chat</h4>
          <div id="playerChat" class="chat-box"></div>
          <input type="text" id="playerChatInput" placeholder="Digite uma mensagem..." />
          <button id="btnPlayerSendChat" class="btn-info" style="margin-top:5px;">
            Enviar
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
/********** CONFIG DO FIREBASE **********/
const firebaseConfig = {
  apiKey: "AIzaSyBQ5czr0wUqNxyqU9X_WHO3DrHOYEAPf7M",
  authDomain: "opoderdodedo.firebaseapp.com",
  databaseURL: "https://opoderdodedo-default-rtdb.firebaseio.com",
  projectId: "opoderdodedo",
  storageBucket: "opoderdodedo.firebasestorage.app",
  messagingSenderId: "931089125837",
  appId: "1:931089125837:web:fa22ae36bd206f28cf7484",
  measurementId: "G-6YE1KQ0VQC"
};
firebase.initializeApp(firebaseConfig);

/********** LÓGICA DO JOGO COMPLETA **********/
/* Aqui você cola as funções createGameAsHost,subscribeHost, etc. 
   incluindo a limpeza de localStorage em enterCodePlayer, 
   joinGameAsHost, endGameHost, etc.
*/

/* Exemplo (simplificado) */

/********** Declarações **********/
let gameCode=null, myPlayerKey=null;
let localCameraStream=null, mediaRecorder=null;
let recordedChunks=[];

/********** DOM Seletores (Host e Player) **********/
/* ... (igual) ... */

/********** Modo Seletor **********/
const modeSelect= document.getElementById('modeSelect');
const btnHost= document.getElementById('btnHost');
const btnPlayer= document.getElementById('btnPlayer');
btnHost.onclick= ()=>{
  modeSelect.classList.add('hidden');
  document.getElementById('hostArea').classList.remove('hidden');
};
btnPlayer.onclick= ()=>{
  modeSelect.classList.add('hidden');
  document.getElementById('playerArea').classList.remove('hidden');
};

/********** Host **********/
/* ... createGameAsHost, joinGameAsHost limpando localStorage, 
   showHostLobby, subscribeHost, etc. ...
*/

async function createGameAsHost(){
  localStorage.clear(); // limpamos caso estivesse algo armazenado
  gameCode= generateGameCode();
  const deck= generateDeck();
  const initialData= {
    status:'lobby',
    players:{}, deck,
    currentCard:null, currentPlayerIndex:0, direction:1,
    rules:[], logs:[], 
    fingerPower:{active:false,owner:null,queue:[]}, chat:[]
  };
  await firebase.database().ref(`games/${gameCode}`).set(initialData);

  showHostLobby(gameCode);
  subscribeHost(gameCode);
}
async function joinGameAsHost(){
  const code= document.getElementById('inputGameCodeHost').value.trim();
  if(!code)return alert("Digite um código!");
  // limpamos localStorage
  localStorage.clear();

  const snap= await firebase.database().ref(`games/${code}`).once('value');
  if(!snap.exists()){
    alert("Partida não encontrada!");
    return;
  }
  gameCode= code;
  showHostLobby(code);
  subscribeHost(code);
}
function showHostLobby(code){
  document.getElementById('hostStep1').classList.add('hidden');
  document.getElementById('hostLobby').classList.remove('hidden');
  document.getElementById('hostGameCode').textContent= code;
  const qrCodeLobby= document.getElementById('qrCodeLobby');
  qrCodeLobby.innerHTML='';
  new QRCode(qrCodeLobby, {
    text: location.origin+location.pathname+`?gameId=${code}`,
    width:160, height:160
  });
  document.getElementById('hostLinkInfo').textContent=
    `Link: ${location.origin+location.pathname}?gameId=${code}`;
}
function subscribeHost(code){
  firebase.database().ref(`games/${code}`).on('value', snap=>{
    if(!snap.exists())return;
    const data= snap.val();
    if(data.status==='lobby'){
      renderHostLobby(data);
    } else if(data.status==='ongoing'){
      document.getElementById('hostLobby').classList.add('hidden');
      document.getElementById('hostGame').classList.remove('hidden');
      renderHostGame(data);
    } else if(data.status==='finished'){
      alert("Partida Encerrada!");
    }
  });
}
function renderHostLobby(data){
  const arr= Object.values(data.players||{});
  document.getElementById('hostPlayersList').innerHTML=
    arr.map(p=>`<div>${p.name}</div>`).join('');
}
function startGameHost(){
  firebase.database().ref(`games/${gameCode}`).update({status:'ongoing'});
}
function renderHostGame(data){
  // Exemplo: 
  document.getElementById('hostStatusPanel').textContent=
    `É a vez de: ${Object.values(data.players||{})[data.currentPlayerIndex]?.name||'???'}`;
  // deck, currentCard, etc.
}
function drawCardHost(){
  // ...
}
function endGameHost(){
  firebase.database().ref(`games/${gameCode}`).update({status:'finished'});
  // limpamos localStorage do host
  localStorage.clear();
}
function sendChatAsHost(){
  // ...
}

/********** Modo Jogador **********/
(function checkUrlForGameId(){
  const params= new URLSearchParams(location.search);
  if(params.has('gameId')){
    // limpamos localStorage para forçar nome novamente
    localStorage.clear();

    const code= params.get('gameId');
    if(code){
      document.getElementById('modeSelect').classList.add('hidden');
      document.getElementById('playerArea').classList.remove('hidden');
      document.getElementById('inputGameCodePlayer').value= code;
      enterCodePlayer();
    }
  }
})();
function enterCodePlayer(){
  const code= document.getElementById('inputGameCodePlayer').value.trim();
  if(!code)return alert("Digite um código!");
  // limpamos localStorage
  localStorage.clear();

  firebase.database().ref(`games/${code}`).once('value', snap=>{
    if(!snap.exists()){
      alert("Partida não encontrada!");
      return;
    }
    gameCode= code;
    document.getElementById('playerStep1').classList.add('hidden');
    document.getElementById('playerRegister').classList.remove('hidden');
  });
}
async function registerPlayerInGame(){
  const name= document.getElementById('inputPlayerName').value.trim();
  if(!name)return alert("Digite seu nome!");
  const ref= firebase.database().ref(`games/${gameCode}/players`).push();
  myPlayerKey= ref.key;
  await ref.set({ name, jokers:0, hasFingerPower:false });
  
  localStorage.setItem("opoderdedo_gameId", gameCode);
  localStorage.setItem("opoderdedo_playerKey", myPlayerKey);
  localStorage.setItem("opoderdedo_playerName", name);

  firebase.database().ref(`games/${gameCode}`).on('value', s=>{
    if(!s.exists())return;
    updatePlayerView(s.val());
  });
  document.getElementById('playerRegister').classList.add('hidden');
}
function updatePlayerView(data){
  // if data.status=== 'lobby', etc.
  // if data.status=== 'ongoing', exibe playerGame
  // se data.status=== 'finished', localStorage.clear()
}
/********** Puxar Carta, Coringa, Poder do Dedo, etc. **********/
/* ... ... */


/********** FUNÇÕES AUXILIARES **********/
function generateGameCode(){ ... }
function generateDeck(){ ... }
function renderCard(rank,suit){ ... }
function addLog(msg){ 
  // ...
}
function finalizeFingerPower(){ 
  // ...
}
</script>

</body>
</html>
