<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>O Poder do Dedo - Mentimeter Style</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase App (compat) + Realtime Database (compat) + Storage (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-storage-compat.js"></script>

  <!-- Pequena biblioteca de QRCode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body {
      margin: 0; padding: 0;
      font-family: Arial, sans-serif;
      background: #222;
      color: #fff;
      min-height: 100vh;
      display: flex; 
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    h1, h2, h3 { text-align: center; }
    a { color: #0ff; }
    button {
      padding: 10px 14px;
      background: #444;
      border: 1px solid #666;
      cursor: pointer;
      color: #fff;
      margin: 5px 0;
    }
    input[type="text"], input[type="file"] {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
    }
    .hidden { display: none !important; }
    .container {
      width: 95%;
      max-width: 600px;
      background: #333;
      border: 1px solid #555;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    .center { text-align: center; }
    .row { display: flex; flex-direction: row; gap: 10px; margin: 5px 0; }
    .player-photo {
      width: 40px; 
      height: 40px; 
      object-fit: cover; 
      border-radius: 50%;
      vertical-align: middle;
      margin-right: 5px;
    }
    .card-front {
      width: 100px;
      height: 140px;
      background: #fff;
      position: relative;
      color: #000;
      border: 2px solid #000;
      border-radius: 5px;
      margin: 0 auto;
    }
    .card-rank-suit {
      position: absolute;
      top: 8px; left: 8px;
      font-size: 1.4rem;
      font-weight: bold;
    }
    .red { color: red; }
    .black { color: black; }
    .card-back {
      width: 30px; 
      height: 40px; 
      background: #aaa;
      border-radius: 3px;
      display: inline-block;
      margin: 2px;
    }
    .rules-list {
      background: #444;
      border: 1px solid #666;
      border-radius: 5px;
      margin: 5px 0;
      padding: 8px;
    }
    .rule-item {
      background: #555;
      margin: 4px 0;
      padding: 4px;
      border-radius: 3px;
    }
    .log {
      background: #111; 
      border: 1px solid #666;
      max-height: 150px;
      overflow-y: auto;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    .finger-box {
      background: #555; 
      padding: 10px; 
      margin: 10px 0; 
      border-radius: 5px;
    }
    video {
      max-width: 100%; 
      background: #000;
    }
    .small-btn {
      padding: 5px 10px; 
      font-size: 0.9rem;
      margin-left: 5px;
      background: #666;
    }
  </style>
</head>

<body>
<h1>O Poder do Dedo</h1>

<div id="modeSelect" class="container">
  <h2>Você é o Organizador ou Jogador?</h2>
  <button id="btnHost">Organizador</button>
  <button id="btnPlayer">Jogador</button>
</div>

<!-- HOST AREA -->
<div id="hostArea" class="container hidden">
  <h2>Modo Organizador</h2>
  <div id="hostStep1">
    <button id="btnCreateGame">Criar Nova Partida</button>
    <p>ou</p>
    <div class="row">
      <input type="text" id="inputGameCodeHost" placeholder="Digite código para entrar"/>
      <button id="btnJoinGameHost">Entrar Partida Existente</button>
    </div>
  </div>

  <div id="hostLobby" class="hidden">
    <h3>Código da Partida: <span id="hostGameCode"></span></h3>
    <div id="qrCodeContainer" class="center"></div>
    <p class="center" id="hostLinkInfo"></p>
    <h4>Jogadores Conectados</h4>
    <div id="hostPlayersList"></div>
    <button id="btnStartGame">Iniciar Partida</button>
  </div>

  <div id="hostGame" class="hidden">
    <div class="row" style="justify-content: space-between;">
      <div>
        <h3>Baralho</h3>
        <div id="deckCount"></div>
        <div id="deckSmallView"></div>
      </div>
      <div>
        <h3>Carta Atual</h3>
        <div id="currentCardHost">Nenhuma carta</div>
        <button id="btnDrawCard">Puxar Carta</button>
      </div>
    </div>

    <h4>Regras Ativas</h4>
    <div id="rulesBox" class="rules-list">Nenhuma</div>

    <h4>Jogadores</h4>
    <div id="hostPlayersStatus"></div>

    <button id="btnEndGame">Encerrar Partida</button>
    <h4>Log</h4>
    <div id="hostLog" class="log"></div>
  </div>
</div>

<!-- PLAYER AREA -->
<div id="playerArea" class="container hidden">
  <h2>Modo Jogador</h2>
  <div id="playerStep1">
    <div class="row">
      <input type="text" id="inputGameCodePlayer" placeholder="Digite o código da partida"/>
      <button id="btnEnterCodePlayer">Entrar</button>
    </div>
    <p class="center">ou use o link/QR Code fornecido pelo Organizador</p>
  </div>

  <div id="playerRegister" class="hidden">
    <h3>Digite seu Nome</h3>
    <input type="text" id="inputPlayerName" placeholder="Seu nome" />
    <h4>Foto (opcional)</h4>
    <input type="file" id="filePlayerPhoto" accept="image/*" />
    <p class="center">ou</p>
    <button id="btnOpenCamera">Tirar Foto Agora</button>

    <div id="cameraOverlay" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);color:#fff;display:flex;align-items:center;justify-content:center;flex-direction:column;">
      <video id="cameraPreview" autoplay muted playsinline style="max-width:80%;border:2px solid #fff;"></video>
      <div>
        <button id="btnCapturePhoto">Capturar</button>
        <button id="btnCloseCamera">Fechar</button>
      </div>
    </div>

    <img id="previewPhoto" src="" alt="" style="max-width:100px; display:none; margin:10px 0;" />
    <button id="btnJoinPlayerGame">Entrar na Partida</button>
  </div>

  <div id="playerLobby" class="hidden">
    <h3>Aguardando Organizador iniciar a partida...</h3>
    <div id="playerLobbyList"></div>
  </div>

  <div id="playerGame" class="hidden">
    <h4 id="playerInfo"></h4>
    <div class="row" style="justify-content: space-between;">
      <div>
        <h4>Carta Atual</h4>
        <div id="currentCardPlayer">Nenhuma carta</div>
      </div>
      <div>
        <h4>Regras Ativas</h4>
        <div id="playerRules" class="rules-list"></div>
      </div>
    </div>

    <div class="finger-box hidden" id="fingerBox">
      <h4>Poder do Dedo Ativo!</h4>
      <p>Clique <strong>AGORA</strong> para não ser o último!</p>
      <button id="btnFingerClick">Clique Rápido!</button>
      <div id="fingerQueue"></div>
    </div>

    <div>
      <button id="btnUseJoker" style="display:none;">Usar Coringa</button>
      <button id="btnActivateFinger" style="display:none;">Usar Poder do Dedo (Carta 8)</button>
      <button id="btnRecordVideo">Gravar Vídeo (Opcional)</button>
      <div id="videoOverlay" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;flex-direction:column;">
        <video id="videoPreview" autoplay muted playsinline style="max-width:80%;border:2px solid #fff;"></video>
        <div>
          <button id="btnStartRecording">Iniciar Gravação</button>
          <button id="btnStopRecording">Parar Gravação</button>
          <button id="btnCloseVideoOverlay">Fechar</button>
        </div>
      </div>
    </div>

    <div id="playerLog" class="log"></div>
  </div>
</div>

<script>
/*
  ----------------------------------------------------
  CONFIGURAÇÃO DO SEU FIREBASE
  ----------------------------------------------------
*/
const firebaseConfig = {
  apiKey: "AIzaSyBQ5czr0wUqNxyqU9X_WHO3DrHOYEAPf7M",
  authDomain: "opoderdodedo.firebaseapp.com",
  databaseURL: "https://opoderdodedo-default-rtdb.firebaseio.com",
  projectId: "opoderdodedo",
  storageBucket: "opoderdodedo.firebasestorage.app",
  messagingSenderId: "931089125837",
  appId: "1:931089125837:web:fa22ae36bd206f28cf7484",
  measurementId: "G-6YE1KQ0VQC"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

/*
  ----------------------------------------------------
  VARIÁVEIS GLOBAIS
  ----------------------------------------------------
*/
let gameCode = null;        // código numérico do jogo (tipo Mentimeter)
let myPlayerKey = null;     // ID do jogador no DB
let myPhotoFile = null;     // Arquivo de foto do jogador (ou base64)
let myPhotoURL = "";        // URL da foto após upload
let localStream = null;     // MediaStream da câmera pro vídeo
let mediaRecorder = null;   // Gravação de vídeo
let recordedChunks = [];

/*
  ----------------------------------------------------
  PEGAR ELEMENTOS
  ----------------------------------------------------
*/
// Seletor de modo
const modeSelect = document.getElementById('modeSelect');
const btnHost = document.getElementById('btnHost');
const btnPlayer = document.getElementById('btnPlayer');

// Area Host
const hostArea = document.getElementById('hostArea');
const hostStep1 = document.getElementById('hostStep1');
const btnCreateGame = document.getElementById('btnCreateGame');
const inputGameCodeHost = document.getElementById('inputGameCodeHost');
const btnJoinGameHost = document.getElementById('btnJoinGameHost');
const hostLobby = document.getElementById('hostLobby');
const hostGameCodeSpan = document.getElementById('hostGameCode');
const qrCodeContainer = document.getElementById('qrCodeContainer');
const hostLinkInfo = document.getElementById('hostLinkInfo');
const hostPlayersList = document.getElementById('hostPlayersList');
const btnStartGame = document.getElementById('btnStartGame');

const hostGame = document.getElementById('hostGame');
const deckCount = document.getElementById('deckCount');
const deckSmallView = document.getElementById('deckSmallView');
const currentCardHost = document.getElementById('currentCardHost');
const btnDrawCard = document.getElementById('btnDrawCard');
const rulesBox = document.getElementById('rulesBox');
const hostPlayersStatus = document.getElementById('hostPlayersStatus');
const btnEndGame = document.getElementById('btnEndGame');
const hostLog = document.getElementById('hostLog');

// Area Player
const playerArea = document.getElementById('playerArea');
const playerStep1 = document.getElementById('playerStep1');
const inputGameCodePlayer = document.getElementById('inputGameCodePlayer');
const btnEnterCodePlayer = document.getElementById('btnEnterCodePlayer');

const playerRegister = document.getElementById('playerRegister');
const inputPlayerName = document.getElementById('inputPlayerName');
const filePlayerPhoto = document.getElementById('filePlayerPhoto');

const cameraOverlay = document.getElementById('cameraOverlay');
const cameraPreview = document.getElementById('cameraPreview');
const btnOpenCamera = document.getElementById('btnOpenCamera');
const btnCapturePhoto = document.getElementById('btnCapturePhoto');
const btnCloseCamera = document.getElementById('btnCloseCamera');
const previewPhoto = document.getElementById('previewPhoto');

const btnJoinPlayerGame = document.getElementById('btnJoinPlayerGame');
const playerLobby = document.getElementById('playerLobby');
const playerLobbyList = document.getElementById('playerLobbyList');

const playerGame = document.getElementById('playerGame');
const playerInfo = document.getElementById('playerInfo');
const currentCardPlayer = document.getElementById('currentCardPlayer');
const playerRules = document.getElementById('playerRules');
const fingerBox = document.getElementById('fingerBox');
const btnFingerClick = document.getElementById('btnFingerClick');
const fingerQueue = document.getElementById('fingerQueue');
const btnUseJoker = document.getElementById('btnUseJoker');
const btnActivateFinger = document.getElementById('btnActivateFinger');
const btnRecordVideo = document.getElementById('btnRecordVideo');
const videoOverlay = document.getElementById('videoOverlay');
const videoPreview = document.getElementById('videoPreview');
const btnStartRecording = document.getElementById('btnStartRecording');
const btnStopRecording = document.getElementById('btnStopRecording');
const btnCloseVideoOverlay = document.getElementById('btnCloseVideoOverlay');
const playerLog = document.getElementById('playerLog');

/*
  ----------------------------------------------------
  EVENT LISTENERS
  ----------------------------------------------------
*/
btnHost.onclick = () => {
  modeSelect.classList.add('hidden');
  hostArea.classList.remove('hidden');
};
btnPlayer.onclick = () => {
  modeSelect.classList.add('hidden');
  playerArea.classList.remove('hidden');
};

// Host
btnCreateGame.onclick = createNewGame;
btnJoinGameHost.onclick = joinGameAsHost;
btnStartGame.onclick = startGameHost;
btnDrawCard.onclick = drawCardHost;
btnEndGame.onclick = endGameHost;

// Player
btnEnterCodePlayer.onclick = enterCodePlayer;
btnJoinPlayerGame.onclick = registerPlayerInGame;
btnOpenCamera.onclick = openCameraOverlay;
btnCloseCamera.onclick = closeCameraOverlay;
btnCapturePhoto.onclick = capturePhoto;

btnFingerClick.onclick = fingerClick;
btnUseJoker.onclick = useJokerPlayer;
btnActivateFinger.onclick = activateFingerPower;

btnRecordVideo.onclick = () => videoOverlay.classList.remove('hidden');
btnCloseVideoOverlay.onclick = closeVideoOverlay;
btnStartRecording.onclick = startVideoRecording;
btnStopRecording.onclick = stopVideoRecording;

/*
  ----------------------------------------------------
  FUNÇÕES - GERAIS
  ----------------------------------------------------
*/
// Gera um código numérico aleatório (6 dígitos)
function generateGameCode() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

// Renderiza uma carta
function renderCard(rank, suit) {
  if (rank === 'Joker') {
    return `
      <div class="card-front" style="background:#ffd700;">
        <div style="position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);font-size:1rem;color:#000;">
          CORINGA
        </div>
      </div>
    `;
  }
  const isRed = (suit === '♥' || suit === '♦');
  return `
    <div class="card-front">
      <div class="card-rank-suit ${isRed ? 'red' : 'black'}">
        ${rank}${suit}
      </div>
    </div>
  `;
}

// Gera um baralho embaralhado
function generateDeck() {
  const suits = ["♥","♦","♣","♠"];
  const ranks = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
  let newDeck = [];
  for (let s of suits) {
    for (let r of ranks) {
      newDeck.push({ rank: r, suit: s });
    }
  }
  for (let i=0; i<3; i++){
    newDeck.push({ rank: "Joker", suit: "Coringa" });
  }
  // shuffle
  for (let i = newDeck.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [newDeck[i], newDeck[j]] = [newDeck[j], newDeck[i]];
  }
  return newDeck;
}

/*
  ----------------------------------------------------
  MODO HOST
  ----------------------------------------------------
*/
async function createNewGame() {
  gameCode = generateGameCode();
  const ref = db.ref(`games/${gameCode}`);
  const deck = generateDeck();
  const initialData = {
    status: 'lobby',
    players: {},
    deck,
    currentCard: null,
    currentPlayerIndex: 0,
    direction: 1,
    rules: [],
    logs: [],
    fingerPower: {
      active: false,
      owner: null,
      queue: []
    },
    videos: []
  };
  await ref.set(initialData);

  showHostLobby();
  hostGameCodeSpan.textContent = gameCode;
  generateQRCode(gameCode);
  hostLinkInfo.innerHTML = `Link p/ jogadores: ${location.origin + location.pathname}?gameId=${gameCode}`;

  // Ouvir mudanças
  ref.on('value', snapshot => {
    const data = snapshot.val();
    if (!data) return;
    renderHostLobby(data);
    if (data.status === 'ongoing') {
      hostLobby.classList.add('hidden');
      hostGame.classList.remove('hidden');
      renderHostGame(data);
    } else if (data.status === 'finished') {
      alert("Partida Encerrada!");
      // Pode exibir algo final
    }
  });
}

function showHostLobby() {
  hostStep1.classList.add('hidden');
  hostLobby.classList.remove('hidden');
}

function generateQRCode(code) {
  qrCodeContainer.innerHTML = '';
  new QRCode(qrCodeContainer, {
    text: location.origin + location.pathname + '?gameId=' + code,
    width: 180,
    height: 180
  });
}

function renderHostLobby(data) {
  const playersObj = data.players || {};
  const playerKeys = Object.keys(playersObj);
  let html = playerKeys.map(k => {
    const p = playersObj[k];
    const photo = p.photoURL ? `<img src="${p.photoURL}" class="player-photo" />` : '';
    return `<div>${photo} ${p.name}</div>`;
  }).join('');
  hostPlayersList.innerHTML = html;
}

function startGameHost() {
  db.ref(`games/${gameCode}`).update({ status: 'ongoing' });
}

function renderHostGame(data) {
  // deck
  deckCount.textContent = `Cartas Restantes: ${data.deck ? data.deck.length : 0}`;
  deckSmallView.innerHTML = (data.deck || []).map(c => `<div class="card-back"></div>`).join('');

  // carta atual
  if (data.currentCard) {
    currentCardHost.innerHTML = renderCard(data.currentCard.rank, data.currentCard.suit);
  } else {
    currentCardHost.textContent = 'Nenhuma carta';
  }

  // Regras
  if (data.rules && data.rules.length > 0) {
    rulesBox.innerHTML = data.rules.map(r => `<div class="rule-item">${r}</div>`).join('');
  } else {
    rulesBox.textContent = 'Nenhuma';
  }

  // Jogadores + status
  const playersObj = data.players || {};
  const playerKeys = Object.keys(playersObj);
  let html = playerKeys.map((k,i) => {
    const p = playersObj[k];
    const photo = p.photoURL ? `<img src="${p.photoURL}" class="player-photo" />` : '';
    const isCurrent = (i === data.currentPlayerIndex) ? ' (Vez)' : '';
    const coringas = (p.jokers && p.jokers>0) ? ` [Coringas: ${p.jokers}]` : '';
    return `<div>${photo} <strong>${p.name}</strong>${isCurrent}${coringas}</div>`;
  }).join('');
  hostPlayersStatus.innerHTML = html;

  // Log
  if (data.logs) {
    hostLog.innerHTML = data.logs.map(l => `<div>${l}</div>`).join('');
    hostLog.scrollTop = hostLog.scrollHeight;
  }
}

async function drawCardHost() {
  const snap = await db.ref(`games/${gameCode}`).once('value');
  const data = snap.val();
  if (!data.deck || data.deck.length === 0) {
    addLogHost("Baralho acabou!");
    return;
  }
  const card = data.deck[0];
  const newDeck = data.deck.slice(1);
  // aplica efeito
  handleCardEffect(card, data);
  // atualiza
  await db.ref(`games/${gameCode}`).update({
    deck: newDeck,
    currentCard: card
  });
}

function endGameHost() {
  db.ref(`games/${gameCode}`).update({ status: 'finished' });
}

async function joinGameAsHost() {
  // Ex: o host digita o code e "entra"
  const code = inputGameCodeHost.value.trim();
  if (!code) return alert("Digite um código!");
  gameCode = code;
  const ref = db.ref(`games/${code}`);
  const snap = await ref.once('value');
  if (!snap.exists()) {
    alert("Esse código não existe!");
    return;
  }
  // Redesenha a tela
  showHostLobby();
  hostGameCodeSpan.textContent = code;
  generateQRCode(code);
  hostLinkInfo.innerHTML = `Link p/ jogadores: ${location.origin + location.pathname}?gameId=${code}`;

  // Começa a ouvir
  ref.on('value', snapshot => {
    const data = snapshot.val();
    if (!data) return;
    renderHostLobby(data);
    if (data.status === 'ongoing') {
      hostLobby.classList.add('hidden');
      hostGame.classList.remove('hidden');
      renderHostGame(data);
    } else if (data.status === 'finished') {
      alert("Partida Encerrada!");
    }
  });
}

function addLogHost(msg) {
  db.ref(`games/${gameCode}/logs`).once('value', snap => {
    let arr = snap.val() || [];
    arr.push(msg);
    db.ref(`games/${gameCode}/logs`).set(arr);
  });
}

/*
  ----------------------------------------------------
  EFEITO DAS CARTAS (HOST)
  ----------------------------------------------------
*/
function handleCardEffect(card, gameData) {
  let logs = gameData.logs || [];
  const rank = card.rank;
  const suit = card.suit;
  const players = Object.values(gameData.players || {});
  let currentIndex = gameData.currentPlayerIndex;
  let direction = gameData.direction;
  let rules = gameData.rules || [];
  const currentPlayerName = players[currentIndex]?.name || '???';

  logs.push(`${currentPlayerName} puxou [${rank}${suit !== 'Coringa'?suit:''}]`);

  let passTurn = true;

  switch(rank) {
    case '4':
      // Adiciona regra
      const newRule = prompt("Nova Regra:");
      if (newRule) {
        rules.push(newRule);
        logs.push(`Regra adicionada: "${newRule}"`);
      }
      break;
    case '6':
      // Quebra todas as regras
      rules = [];
      logs.push("TODAS as regras foram quebradas!");
      break;
    case '8':
      // Poder do Dedo -> player que puxou ganha "hasFingerPower"
      const pKey = Object.keys(gameData.players)[currentIndex];
      if (pKey) {
        db.ref(`games/${gameCode}/players/${pKey}`).update({
          hasFingerPower: true
        });
        logs.push(`${currentPlayerName} obteve o Poder do Dedo!`);
      }
      break;
    case '9':
      // inverte
      direction = direction * -1;
      logs.push("O sentido foi invertido!");
      break;
    case '10':
      // pula
      passTurn = false;
      setTimeout(() => {
        let newIndex = currentIndex + direction;
        if (newIndex < 0) newIndex = players.length - 1;
        if (newIndex >= players.length) newIndex = 0;
        // pula outro
        newIndex += direction;
        if (newIndex < 0) newIndex = players.length - 1;
        if (newIndex >= players.length) newIndex = 0;
        db.ref(`games/${gameCode}`).update({
          currentPlayerIndex: newIndex,
          direction,
          logs,
          rules
        });
      }, 500);
      break;
    case 'J':
      logs.push(`${currentPlayerName} bebe 1 dose!`);
      // podemos mandar "alert" pro jogador
      sendDrinkAlert(gameData, currentIndex);
      break;
    case 'Q':
      logs.push("Todas as mulheres bebem 1 dose!");
      break;
    case 'K':
      logs.push("Todos os homens bebem 1 dose!");
      break;
    case 'Joker':
      // +1 coringa pro current
      const pKeyJoker = Object.keys(gameData.players)[currentIndex];
      if (pKeyJoker) {
        const oldJ = players[currentIndex].jokers || 0;
        db.ref(`games/${gameCode}/players/${pKeyJoker}/jokers`).set(oldJ+1);
        logs.push(`${currentPlayerName} ganhou 1 coringa!`);
      }
      break;
    default:
      // A,2,3,5,7 etc
      // Exemplo: "2" => distribui 2 doses
      // Vamos só mandar log
  }

  if (passTurn && rank !== '10') {
    let newIndex = currentIndex + direction;
    if (newIndex < 0) newIndex = players.length - 1;
    if (newIndex >= players.length) newIndex = 0;
    db.ref(`games/${gameCode}`).update({
      currentPlayerIndex: newIndex,
      direction,
      rules,
      logs
    });
  } else {
    // só atualiza logs e direction e rules
    db.ref(`games/${gameCode}`).update({
      direction,
      rules,
      logs
    });
  }
}

function sendDrinkAlert(gameData, playerIndex) {
  // Podemos setar algo no player
  const pKey = Object.keys(gameData.players)[playerIndex];
  if (!pKey) return;
  db.ref(`games/${gameCode}/players/${pKey}/needsToDrink`).set(Date.now());
}

/*
  ----------------------------------------------------
  MODO JOGADOR
  ----------------------------------------------------
*/
function enterCodePlayer() {
  const code = inputGameCodePlayer.value.trim();
  if (!code) return alert("Digite o código da partida!");
  // Verifica se existe
  db.ref(`games/${code}`).once('value', snap => {
    if (!snap.exists()) {
      alert("Partida não encontrada!");
      return;
    }
    gameCode = code;
    // Vai pra etapa de registro
    playerStep1.classList.add('hidden');
    playerRegister.classList.remove('hidden');
  });
}

// Se a pessoa acessa via link "?gameId=123456"
(function checkUrlForGameId() {
  const params = new URLSearchParams(location.search);
  if (params.has('gameId')) {
    const code = params.get('gameId');
    if (code) {
      // pular steps e já preencher
      playerArea.classList.remove('hidden');
      modeSelect.classList.add('hidden');
      inputGameCodePlayer.value = code;
      enterCodePlayer();
    }
  }
})();

// Foto do jogador
filePlayerPhoto.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) {
    myPhotoFile = file;
    const reader = new FileReader();
    reader.onload = (ev) => {
      previewPhoto.src = ev.target.result;
      previewPhoto.style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
});

async function registerPlayerInGame() {
  const name = inputPlayerName.value.trim();
  if (!name) return alert("Digite seu nome!");
  if (!gameCode) return alert("Não há gameCode definido!");

  // Faz upload da foto (se tiver)
  if (myPhotoFile) {
    const storageRef = storage.ref(`games/${gameCode}/photos/${Date.now()}_${myPhotoFile.name}`);
    await storageRef.put(myPhotoFile);
    myPhotoURL = await storageRef.getDownloadURL();
  } else if (previewPhoto.src && previewPhoto.style.display !== 'none') {
    // Caso a foto tenha vindo da câmera (base64)
    const blob = await dataURLtoBlob(previewPhoto.src);
    const storageRef = storage.ref(`games/${gameCode}/photos/${Date.now()}.png`);
    await storageRef.put(blob);
    myPhotoURL = await storageRef.getDownloadURL();
  }

  // Cria player no DB
  const playersRef = db.ref(`games/${gameCode}/players`).push();
  myPlayerKey = playersRef.key;
  await playersRef.set({
    name,
    photoURL: myPhotoURL,
    jokers: 0,
    hasFingerPower: false
  });

  playerRegister.classList.add('hidden');

  // Vamos ouvir o jogo
  db.ref(`games/${gameCode}`).on('value', snap => {
    const data = snap.val();
    if (!data) return;
    updatePlayerView(data);
  });
}

function updatePlayerView(gameData) {
  // Se status = lobby, mostra playerLobby
  if (gameData.status === 'lobby') {
    playerLobby.classList.remove('hidden');
    playerGame.classList.add('hidden');
    // mostrar lista
    const plist = Object.values(gameData.players||{});
    playerLobbyList.innerHTML = plist.map(p => {
      const pic = p.photoURL ? `<img src="${p.photoURL}" class="player-photo" />` : '';
      return `<div>${pic} ${p.name}</div>`;
    }).join('');
  }
  else if (gameData.status === 'ongoing') {
    playerLobby.classList.add('hidden');
    playerGame.classList.remove('hidden');

    // Info
    const pObj = gameData.players?.[myPlayerKey];
    if (!pObj) {
      playerInfo.textContent = "Você não está neste jogo?";
      return;
    } else {
      playerInfo.textContent = `Olá, ${pObj.name} | Coringas: ${pObj.jokers||0}`;
    }

    // current card
    if (gameData.currentCard) {
      currentCardPlayer.innerHTML = renderCard(gameData.currentCard.rank, gameData.currentCard.suit);
    } else {
      currentCardPlayer.textContent = 'Nenhuma carta';
    }

    // Regras
    if (gameData.rules && gameData.rules.length > 0) {
      playerRules.innerHTML = gameData.rules.map(r => `<div class="rule-item">${r}</div>`).join('');
    } else {
      playerRules.innerHTML = '<p>Nenhuma</p>';
    }

    // Se player tem coringa
    btnUseJoker.style.display = (pObj.jokers>0) ? 'inline-block' : 'none';
    // Se tem finger power
    btnActivateFinger.style.display = pObj.hasFingerPower ? 'inline-block' : 'none';

    // Finger Power global
    const fp = gameData.fingerPower || {};
    if (fp.active) {
      fingerBox.classList.remove('hidden');
      // Se eu já cliquei
      const clicked = (fp.queue || []).find(x => x.playerKey === myPlayerKey);
      if (clicked) {
        btnFingerClick.disabled = true;
        btnFingerClick.textContent = "Você já clicou!";
      } else {
        btnFingerClick.disabled = false;
        btnFingerClick.textContent = "Clique Rápido!";
      }
      // Mostrar ordem
      fingerQueue.innerHTML = (fp.queue||[]).map((q,i) => `${i+1}º: ${q.name}`).join('<br>');
    } else {
      fingerBox.classList.add('hidden');
    }

    // Log
    if (gameData.logs) {
      playerLog.innerHTML = gameData.logs.map(l => `<div>${l}</div>`).join('');
      playerLog.scrollTop = playerLog.scrollHeight;
    }

    // Se needsToDrink for mim
    if (pObj.needsToDrink) {
      // Ex: se a gente setar esse valor com um timestamp
      alert("Você precisa beber!");
      // reseta
      db.ref(`games/${gameCode}/players/${myPlayerKey}/needsToDrink`).remove();
    }
  }
  else if (gameData.status === 'finished') {
    alert("Partida Encerrada!");
  }
}

// Usar Coringa
function useJokerPlayer() {
  db.ref(`games/${gameCode}/players/${myPlayerKey}`).once('value', snap => {
    const p = snap.val();
    if (!p) return;
    if (p.jokers <= 0) return alert("Você não tem coringa.");
    const newVal = p.jokers - 1;
    db.ref(`games/${gameCode}/players/${myPlayerKey}/jokers`).set(newVal);
    addLog(`Usou um Coringa para não beber!`);
  });
}

// Ativar Poder do Dedo
function activateFingerPower() {
  // Marca fingerPower ativo
  // E add queue com esse player
  db.ref(`games/${gameCode}/fingerPower`).set({
    active: true,
    owner: myPlayerKey,
    queue: [{ playerKey: myPlayerKey, name: inputPlayerName.value.trim() }]
  });
  // remove hasFingerPower
  db.ref(`games/${gameCode}/players/${myPlayerKey}/hasFingerPower`).set(false);
  addLog(`${inputPlayerName.value} ativou o Poder do Dedo!`);
}

function fingerClick() {
  db.ref(`games/${gameCode}/fingerPower/queue`).once('value', snap => {
    let queue = snap.val() || [];
    // se já tô, sai
    if (queue.find(x => x.playerKey === myPlayerKey)) return;
    queue.push({ playerKey: myPlayerKey, name: inputPlayerName.value.trim() });
    db.ref(`games/${gameCode}/fingerPower/queue`).set(queue);

    // Se quiser encerrar automaticamente em X seg, pode ser no host
    // ou assim que todo mundo tiver clicado.
  });
}

// Podemos chamar do Host (ou timer) a função que decide o último:
function finalizeFingerPower() {
  db.ref(`games/${gameCode}/fingerPower`).once('value', snap => {
    const fp = snap.val();
    if (!fp || !fp.queue || fp.queue.length===0) return;
    const last = fp.queue[fp.queue.length-1];
    // mandar esse last beber
    addLog(`O último a clicar foi ${last.name}, então ele bebe!`);
    db.ref(`games/${gameCode}/players/${last.playerKey}/needsToDrink`).set(Date.now());
    // desativa
    db.ref(`games/${gameCode}/fingerPower`).update({ active: false, queue: [] });
  });
}

/*
  ----------------------------------------------------
  VIDEO GRAVAÇÃO (PLAYER)
  ----------------------------------------------------
*/
function closeVideoOverlay() {
  videoOverlay.classList.add('hidden');
  stopVideoStream();
}
async function startVideoRecording() {
  if (!localStream) {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      videoPreview.srcObject = localStream;
    } catch(err) {
      alert("Não foi possível acessar câmera: " + err);
      return;
    }
  }
  recordedChunks = [];
  mediaRecorder = new MediaRecorder(localStream);
  mediaRecorder.ondataavailable = e => {
    if (e.data.size>0) recordedChunks.push(e.data);
  };
  mediaRecorder.onstop = async () => {
    if (recordedChunks.length>0) {
      const blob = new Blob(recordedChunks, { type:'video/mp4' });
      // faz upload
      const storageRef = storage.ref(`games/${gameCode}/videos/${Date.now()}.mp4`);
      await storageRef.put(blob);
      const videoURL = await storageRef.getDownloadURL();
      addLog(`Gravou vídeo! URL: ${videoURL}`);
      // se quiser registrar no DB
      db.ref(`games/${gameCode}/videos`).once('value', s => {
        let arr = s.val() || [];
        arr.push({ playerKey: myPlayerKey, url: videoURL });
        db.ref(`games/${gameCode}/videos`).set(arr);
      });
    }
  };
  mediaRecorder.start();
  addLog("Iniciou Gravação...");
}
function stopVideoRecording() {
  if (mediaRecorder && mediaRecorder.state==='recording') {
    mediaRecorder.stop();
    addLog("Parou Gravação.");
  }
}
function stopVideoStream() {
  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
  }
  localStream = null;
  videoPreview.srcObject = null;
}

/*
  ----------------------------------------------------
  FOTO - CÂMERA
  ----------------------------------------------------
*/
async function openCameraOverlay() {
  cameraOverlay.classList.remove('hidden');
  try {
    const camStream = await navigator.mediaDevices.getUserMedia({ video: true });
    cameraPreview.srcObject = camStream;
  } catch (err) {
    alert("Não foi possível abrir câmera: " + err);
    closeCameraOverlay();
  }
}
function closeCameraOverlay() {
  cameraOverlay.classList.add('hidden');
  if (cameraPreview.srcObject) {
    cameraPreview.srcObject.getTracks().forEach(t => t.stop());
    cameraPreview.srcObject = null;
  }
}
function capturePhoto() {
  if (!cameraPreview.srcObject) return;
  const videoTrack = cameraPreview.srcObject.getVideoTracks()[0];
  const capture = new ImageCapture(videoTrack);
  capture.takePhoto()
    .then(blob => {
      const url = URL.createObjectURL(blob);
      previewPhoto.src = url;
      previewPhoto.style.display = 'block';
      myPhotoFile = null; // limpamos pois é a camera que manda
      closeCameraOverlay();
    })
    .catch(err => {
      alert("Falha ao capturar foto: "+err);
    });
}

/*
  ----------------------------------------------------
  UTILS
  ----------------------------------------------------
*/
// Adiciona log no array logs do game
function addLog(msg) {
  db.ref(`games/${gameCode}/logs`).once('value', snap => {
    let arr = snap.val() || [];
    arr.push(`${inputPlayerName.value}: ${msg}`);
    db.ref(`games/${gameCode}/logs`).set(arr);
  });
}

// Converter base64 -> Blob
function dataURLtoBlob(dataurl) {
  return fetch(dataurl).then(res => res.blob());
}
</script>
</body>
</html>
